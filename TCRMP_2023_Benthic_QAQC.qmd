---
title: "TCRMP 2023 Benthic QAQC"
author: "Sarah Heidmann"
format: html
editor: visual
toc: true
---

#### 2025-02-03

QAQC for TCRMP coral health and algae height data for 2023 and 2024 Post Bleaching (PBL). Suggestions for additions and improvement are welcomed.

Luckily, the data entry system catches a lot of easy mistakes like mispellings. We just have to go through the mistakes it might not catch. When we catch some that are fixable, change online and export again, or if the online database has already been cleared, change directly in the data.

```{r, warning=FALSE, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo=FALSE)
library(tidyverse, quietly = TRUE)
library(knitr)
options(knitr.kable.NA = '')
library(DT)

# Read qaqc'd data for fish and diadema
chs_raw_23 <- read_csv("data/2023/TCRMP_CoralHealth_2023_webexport.csv") %>% 
   replace_na(list(`Old mortality`=0, `Recent mortality`=0,
                  `Bl sp`=0,`Bl p`=0, `Bl vp`=0, `Bl bl`=0))
chs_raw_24 <- read_csv("data/2023/TCRMP_CoralHealth_2024PBL_webexport.csv") %>% 
   replace_na(list(`Old mortality`=0, `Recent mortality`=0,
                  `Bl sp`=0,`Bl p`=0, `Bl vp`=0, `Bl bl`=0))
ahs_raw <- read_csv("data/2023/TCRMP_AlgaeHeights_2023_webexport.csv")

# Species master for QAQC numbers
species <- read_csv("data/coral_size_flags_2024.csv") %>% 
   rename("LENGTH95"="MAX_DIAMETER95")

```

# Overview

How big are the datasets?

```{r}
corals23 <- length(unique(chs_raw_23$`Transect coral`))
corals24 <- length(unique(chs_raw_24$`Transect coral`))
```

Coral health 2023 has `r corals23` corals. Coral health 2024PBL has `r corals24` corals.

```{r, tab.cap="Table 1_23. Do we have all the coral transects in 2023? We should have 6 transects each at 33 sites."}
# Summarize number of transects by site
chs_sitesum_23 <- chs_raw_23 %>% 
   group_by(`Site name`,Rep) %>% 
   summarize(n=1, .groups="drop_last") %>% 
   summarize(Transects = sum(n))
# High level look at number of reps
chs_sitesum_23 %>% 
   group_by(Transects) %>% 
   summarize(Sites = length(`Site name`)) %>% kable()
```

```{r, tab.cap="Table 2_23. Sites with less than 6 coral health transects in 2023."}
# See the sitewise list
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
chs_sitesum_23 %>% filter(Transects<6) %>% arrange(Transects) %>% 
   datatable()
```

```{r, tab.cap="Table 1_24. Do we have all the coral transects in 2024PBL? We should have 6 transects each at 33 sites."}
# Summarize number of transects by site
chs_sitesum_24 <- chs_raw_24 %>% 
   group_by(`Site name`,Rep) %>% 
   summarize(n=1, .groups="drop_last") %>% 
   summarize(Transects = sum(n))
# High level look at number of reps
chs_sitesum_24 %>% 
   group_by(Transects) %>% 
   summarize(Sites = length(`Site name`)) %>% kable()
```

```{r, tab.cap="Table 2_24. Sites with less than 6 coral health transects in 2024PBL."}
# See the sitewise list
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
chs_sitesum_24 %>% filter(Transects<6) %>% arrange(Transects) %>% datatable()
```

```{r, tab.cap="Table 3. Do we have all the algae height transects in 2023? We should have 6 transects each at 33 sites."}
# Summarize number of transects by site
ahs_sitesum <- ahs_raw %>% 
   group_by(`Site name`,Rep) %>% 
   summarize(n=1, .groups="drop_last") %>% 
   summarize(Transects = sum(n))
# High level look at number of reps
ahs_sitesum %>% 
   group_by(Transects) %>% 
   summarize(Sites = length(`Site name`)) %>% kable()
```

```{r, tab.cap="Table 4. Sites with less than 6 algae height transects in 2023."}
# See the sitewise list
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
ahs_sitesum %>% filter(Transects<6) %>% arrange(Transects) %>% 
   datatable()
```

We didn't do algae heights in 2024PBL.

## Date ranges

```{r}
# Date ranges for each survey type
ch_range_23 <- range(chs_raw_23$`Date completed`)
ch_range_24 <- range(chs_raw_24$`Date completed`)
ah_range <- range(ahs_raw$`Date completed`)
```

Coral health 2023 took place between dates: `r ch_range_23`

Coral health 2024PBL took place between dates: `r ch_range_24`

Algae heights took place between dates: `r ah_range`

## Notes

Are there any notes we should know about?

```{r}
cat("Coral health notes for 2023:")
chs_raw_23 %>% filter(!is.na(`Site Notes`)) %>% 
   pull(`Site Notes`) %>% 
   unique()
cat("Coral health notes for 2024PBL:")
chs_raw_24 %>% filter(!is.na(`Site Notes`)) %>% 
   pull(`Site Notes`) %>% 
   unique()
cat("Algae heights notes for 2023:")
ahs_raw %>% filter(!is.na(Notes)) %>% 
   pull(Notes) %>% 
   unique()
```

# Corals

## Occurrence

```{r, tab.cap="Table 5_23. Percent occurrence of each coral species in 2023, overall and by diver. You can use this table to look at rare species and possible mis-IDs."}
chs_corals_23 <- chs_raw_23 %>% 
   select(`Site name`, Rep, Name, Method, `Transect coral`, 
          `Coral full name`, `Length cm`, `Width cm`, `Height cm`,
          `Bl sp`, `Bl p`, `Bl vp`, `Bl bl`, 
          `Old mortality`, `Recent mortality`) %>% 
   unique()
# Standardize to total number of corals seen
diver_corals_23 <- chs_corals_23 %>% 
   group_by(Name) %>% 
   summarize(Corals = length(`Transect coral`)) %>% 
   add_row(Name="Total", Corals=nrow(chs_corals_23)) 
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
chs_corals_23 %>% 
   group_by(`Coral full name`, Name) %>% 
   summarize(n = length(`Transect coral`), .groups = "drop") %>% 
   pivot_wider(id_cols = c(`Coral full name`), 
               names_from = Name, values_from = n, values_fill = 0) %>% 
   mutate(Total = rowSums(select(.,-`Coral full name`)), 
          .after = `Coral full name`) %>% 
   pivot_longer(cols = !`Coral full name`, 
                names_to = "Name", values_to = "n") %>% 
   left_join(diver_corals_23, by="Name") %>% 
   mutate(prop = round(n / Corals*100,1)) %>% 
   pivot_wider(id_cols=c(`Coral full name`),
               names_from = Name, values_from = prop) %>% 
   datatable()
```

```{r, fig.cap="Figure 1_23. Commonness of each coral species seen in 2023 as proportion of total, colored by observing diver."}
# #| fig-cap: "other option for fig cap"
chs_corals_23 %>% 
   ggplot(data=., aes(x=`Coral full name`, fill = Name)) +
   geom_bar(aes(y = after_stat(count)/sum(after_stat(count)))) +
   ylab("Proportion of Corals Seen")+
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, tab.cap="Table 5_24. Percent occurrence of each coral species in 2024PBL, overall and by diver. You can use this table to look at rare species and possible mis-IDs."}
chs_corals_24 <- chs_raw_24 %>% 
   select(`Site name`, Rep, Name, Method, `Transect coral`,
          `Coral full name`, `Length cm`, `Width cm`, `Height cm`,
          `Bl sp`, `Bl p`, `Bl vp`, `Bl bl`, 
          `Old mortality`, `Recent mortality`) %>% 
   unique() 
# Standardize to total number of corals seen
diver_corals_24 <- chs_corals_24 %>% 
   group_by(Name) %>% 
   summarize(Corals = length(`Transect coral`)) %>% 
   add_row(Name="Total", Corals=nrow(chs_corals_24)) 
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
chs_corals_24 %>% 
   group_by(`Coral full name`, Name) %>% 
   summarize(n = length(`Transect coral`), .groups = "drop") %>% 
   pivot_wider(id_cols = c(`Coral full name`), 
               names_from = Name, values_from = n, values_fill = 0) %>% 
   mutate(Total = rowSums(select(.,-`Coral full name`)), 
          .after = `Coral full name`) %>% 
   pivot_longer(cols = !`Coral full name`, 
                names_to = "Name", values_to = "n") %>% 
   left_join(diver_corals_24, by="Name") %>% 
   mutate(prop = round(n / Corals*100,1)) %>% 
   pivot_wider(id_cols=c(`Coral full name`),
               names_from = Name, values_from = prop) %>% 
   datatable()
```

```{r, fig.cap="Figure 1_24. Commonness of each coral species seen in 2024PBL as proportion of total, colored by observing diver."}
chs_corals_24 %>% 
   ggplot(data=., aes(x=`Coral full name`, fill = Name)) +
   geom_bar(aes(y = after_stat(count)/sum(after_stat(count)))) +
   ylab("Proportion of Corals Seen")+
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

## Abundance

```{r, tab.cap="Table 6_23. How many corals did we see on average on transects across sites in 2023?"}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
 chs_corals_23 %>% 
   group_by(`Site name`, Method, Rep) %>% 
   summarize(Corals = length(`Transect coral`), .groups = "drop_last") %>% 
   summarize(mean = round(mean(Corals),1), sd = round(sd(Corals),1),
             min = min(Corals), max = max(Corals),
             .groups="drop") %>% 
   arrange(desc(mean)) %>% 
   datatable()
```

```{r, tab.cap="Table 6_24. How many corals did we see on average on transects across sites in 2024PBL?"}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
chs_corals_24 %>% 
   group_by(`Site name`, Method, Rep) %>% 
   summarize(Corals = length(`Transect coral`), .groups = "drop_last") %>% 
   summarize(mean = round(mean(Corals),1), sd = round(sd(Corals),1),
             min = min(Corals), max = max(Corals),
             .groups="drop") %>% 
   arrange(desc(mean)) %>% 
   datatable()
```

## Sizing

### Size Summaries

```{r, tab.cap="Table 7_23. What did the max dimension (length in cm) of each coral species look like in 2023?"}
# Do we want to add width and height to this check?
# See Fig 4 of ncrmp for example.
# would need to pivot_longer the dimensions then summarize then wrap.
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
chs_corals_23 %>% 
   group_by(`Coral full name`) %>% 
   summarize(n = length(`Length cm`),
             mean = round(mean(`Length cm`),1), sd = round(sd(`Length cm`),1),
             min = min(`Length cm`), max = max(`Length cm`),
             .groups = "drop") %>% 
   arrange(`Coral full name`) %>% 
   datatable(caption="")
```

```{r, tab.cap="Table 7_24. What did the max dimension (length in cm) of each coral species look like in 2024PBL?"}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
chs_corals_24 %>% 
   group_by(`Coral full name`) %>% 
   summarize(n = length(`Length cm`),
             mean = round(mean(`Length cm`),1), sd = round(sd(`Length cm`),1),
             min = min(`Length cm`), max = max(`Length cm`),
             .groups = "drop") %>% 
   arrange(`Coral full name`) %>% datatable()
```

```{r, fig.cap="Figure 2_23. Size frequency distributions of the top 10 most common coral species in 2023."}
commcoral <- chs_corals_23 %>% 
   group_by(`Coral full name`) %>% 
   summarize(n = length(`Coral full name`)) %>% 
   arrange(desc(n)) %>% slice_head(n=10) %>% pull(`Coral full name`)
chs_corals_23 %>% 
   filter(`Coral full name` %in% commcoral) %>% 
   ggplot(data=.) + 
   geom_histogram(aes(x=`Length cm`), binwidth=10) + 
   facet_wrap(~`Coral full name`, scales = "free")
```

```{r, fig.cap="Figure 2_24. Size frequency distributions of the top 10 most common coral species in 2024PBL."}
chs_corals_24 %>% 
   filter(`Coral full name` %in% commcoral) %>% 
   ggplot(data=.) + 
   geom_histogram(aes(x=`Length cm`), binwidth=10) + 
   facet_wrap(~`Coral full name`, scales = "free")
```

```{r, fig.cap="Figure 3_23. Size frequency distributions of all corals observed by each diver in 2023.", warning=FALSE}
chs_corals_23 %>% 
   ggplot(data=.) + 
   geom_histogram(aes(x=`Length cm`), binwidth=10) + 
   scale_x_continuous(limits=c(0,100)) +
   facet_wrap(~Name, scales = "free_y")
```

```{r, fig.cap="Figure 3_24. Size frequency distributions of all corals observed by each diver in 2024PBL.", warning = FALSE}
chs_corals_24 %>% 
   ggplot(data=.) + 
   geom_histogram(aes(x=`Length cm`), binwidth=10) + 
   scale_x_continuous(limits=c(0,100)) +
   facet_wrap(~Name, scales = "free_y")
```

### Size Flags

These all combine 2023 and 2024PBL for simplicity.

```{r}
coral_size <- chs_corals_23 %>% 
   bind_rows(chs_corals_24) %>% 
# Join to master list to set flags
   left_join(species, by="Coral full name") %>% 
   # If length or height pass the 95%, flag it.
   mutate(flagL = ifelse(`Length cm` > LENGTH95, "yes","no"),
          flagH = ifelse(`Height cm` > HEIGHT95,"yes","no"))
# Calculate percent flagged for length
persizeflagL <- round(summary(as.factor(coral_size$flagL))[2] / nrow(coral_size) *100, 1) 
# Calculate percent flagged for length
persizeflagH <- round(summary(as.factor(coral_size$flagH))[2] / nrow(coral_size) *100, 1) 
# Make table of flags
size_flag <- coral_size %>% filter(flagL == "yes" | flagH =="yes") %>%
   select(`Site name`,Rep,Name,
          `Coral full name`,flagL,flagH,
          `Length cm`,LENGTH95,`Height cm`,HEIGHT95)
```

There were `r persizeflagL`% of coral observations flagged on length, and `r persizeflagH`% of coral observations flagged on height.

```{r, tab.cap="Table 8. All coral observations that were flagged on either length or height for being larger than NOAA's 95th percentile in 2023 and 2024PBL."}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
datatable(size_flag)
```

```{r, tab.cap="Table 9. Frequency of flagging of each coral species on either length or height for being larger than NOAA's 95th percentile in 2023 and 2024PBL. We might want to change the size guidelines on these."}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
# Summarize size flag table by species
size_flag %>%
   mutate(flagL=case_match(flagL, "yes"~1, "no"~0),
          flagH=case_match(flagH,"yes"~1, "no"~0)) %>% 
   group_by(`Coral full name`,LENGTH95,HEIGHT95) %>%
   summarize(FlagsL = sum(flagL),
             FlagsH = sum(flagH), .groups="drop") %>%
   mutate(Flags = FlagsL+FlagsH) %>% 
   select(`Coral full name`, Flags, FlagsL, LENGTH95, FlagsH,HEIGHT95) %>% 
   arrange(desc(Flags)) %>% datatable()
```

```{r, tab.cap="Table 10. Number of corals each diver saw that were flagged on either length or height for being larger than NOAA's 95th percentile in 2023 and 2024PBL. The observers who had the most flags may (or may not) need some sizing practice."}
# Standardize flags to a percentage of total corals seen
# First calculate total corals
diver_corals <- chs_corals_23 %>% 
   bind_rows(chs_corals_24) %>% 
   group_by(Name) %>% 
   summarize(Corals = length(`Transect coral`))
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
size_flag %>% 
   mutate(flagL=case_match(flagL, "yes"~1, "no"~0),
          flagH=case_match(flagH,"yes"~1, "no"~0)) %>% 
   group_by(Name) %>%
   summarize(FlagsL = sum(flagL),
             FlagsH = sum(flagH)) %>%
   mutate(Flags = FlagsL+FlagsH) %>% 
   left_join(diver_corals,by="Name") %>%
   mutate(PercentFlagged = round(Flags / Corals*100)) %>%
   arrange(desc(PercentFlagged)) %>% datatable()
```

## Mortality

```{r, fig.cap="Figure 4_23. Prevalence of old and new morality by coral species in 2023."}
chs_corals_23 %>%  
   mutate(`Old mortality`= ifelse(`Old mortality`>0,1,0),
          `Recent mortality`= ifelse(`Recent mortality`>0,1,0)) %>% 
   group_by(`Coral full name`) %>% 
   summarize(`Old mortality`=sum(`Old mortality`)/length(`Old mortality`),
             `Recent mortality`=sum(`Recent mortality`)/length(`Recent mortality`),
             .groups = "drop") %>% 
   pivot_longer(cols = c(`Old mortality`, `Recent mortality`), 
                names_to = "Type", values_to = "value") %>% 
   ggplot(data=., aes(x=`Coral full name`, fill =Type)) +
   geom_bar(stat = "identity", position = "dodge", 
            aes(y = value)) +
   #geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, fig.cap="Figure 4_24. Prevalence of old and new morality by coral species in 2024PBL."}
chs_corals_24 %>%  
   mutate(`Old mortality`= ifelse(`Old mortality`>0,1,0),
          `Recent mortality`= ifelse(`Recent mortality`>0,1,0)) %>% 
   group_by(`Coral full name`) %>% 
   summarize(`Old mortality`=sum(`Old mortality`)/length(`Old mortality`),
             `Recent mortality`=sum(`Recent mortality`)/length(`Recent mortality`),
             .groups = "drop") %>% 
   pivot_longer(cols = c(`Old mortality`, `Recent mortality`), 
                names_to = "Type", values_to = "value") %>% 
   ggplot(data=., aes(x=`Coral full name`, fill =Type)) +
   geom_bar(stat = "identity", position = "dodge", 
            aes(y = value)) +
   #geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, fig.cap="Figure 5_23. Prevalence of old and new morality by diver in 2023. Check for possible over- or under-estimating."}
coraldiverlist_23 <- sort(unique(chs_corals_23$Name))
chs_corals_23 %>%  
   mutate(`Old mortality`= ifelse(`Old mortality`>0,1,0),
          `Recent mortality`= ifelse(`Recent mortality`>0,1,0)) %>% 
   group_by(Name) %>% 
   summarize(`Old mortality`=sum(`Old mortality`)/length(`Old mortality`),
             `Recent mortality`=sum(`Recent mortality`)/length(`Recent mortality`),
             .groups = "drop") %>% 
   pivot_longer(cols = c(`Old mortality`, `Recent mortality`), 
                names_to = "Type", values_to = "value") %>% 
   add_row(Name = "Overall", Type="Old mortality", 
           value = nrow(filter(chs_corals_23,`Old mortality`>0))/nrow(chs_corals_23)) %>% 
   add_row(Name = "Overall", Type="Recent mortality", 
           value = nrow(filter(chs_corals_23,`Recent mortality`>0))/nrow(chs_corals_23)) %>% 
   mutate(Name=factor(Name,levels=c("Overall",coraldiverlist_23))) %>% 
   ggplot(data=., aes(x=Name, fill =Type)) +
   geom_bar(stat = "identity", position = "dodge", 
            aes(y = value)) +
   #geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, fig.cap="Figure 5_24. Prevalence of old and new morality by diver in 2024PBL. Check for possible over- or under-estimating."}
coraldiverlist_24 <- sort(unique(chs_corals_24$Name))
chs_corals_24 %>%  
   mutate(`Old mortality`= ifelse(`Old mortality`>0,1,0),
          `Recent mortality`= ifelse(`Recent mortality`>0,1,0)) %>% 
   group_by(Name) %>% 
   summarize(`Old mortality`=sum(`Old mortality`)/length(`Old mortality`),
             `Recent mortality`=sum(`Recent mortality`)/length(`Recent mortality`),
             .groups = "drop") %>% 
   pivot_longer(cols = c(`Old mortality`, `Recent mortality`), 
                names_to = "Type", values_to = "value") %>% 
   add_row(Name = "Overall", Type="Old mortality", 
           value = nrow(filter(chs_corals_24,`Old mortality`>0))/nrow(chs_corals_24)) %>% 
   add_row(Name = "Overall", Type="Recent mortality", 
           value = nrow(filter(chs_corals_24,`Recent mortality`>0))/nrow(chs_corals_24)) %>% 
   mutate(Name=factor(Name,levels=c("Overall",coraldiverlist_24))) %>% 
   ggplot(data=., aes(x=Name, fill =Type)) +
   geom_bar(stat = "identity", position = "dodge", 
            aes(y = value)) +
   #geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, warning=FALSE, fig.cap="Figure 6_23. Extent of old and new morality by coral species in 2023."}
chs_corals_23 %>%  
   pivot_longer(cols = c(`Old mortality`, `Recent mortality`), 
                names_to = "Type", values_to = "value") %>% 
   group_by(`Coral full name`, Type) %>% 
   summarize(mean = round(mean(value),2), sd = round(sd(value),2), 
             n = length(value), 
             .groups = "drop") %>% 
   ggplot(data=., aes(x=`Coral full name`, fill =Type)) +
   geom_bar(stat = "identity", position = "stack", 
            aes(y = mean)) +
   #geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, warning=FALSE, fig.cap="Figure 6_24. Extent of old and new morality by coral species in 2024PBL."}
chs_corals_24 %>%  
   pivot_longer(cols = c(`Old mortality`, `Recent mortality`), 
                names_to = "Type", values_to = "value") %>% 
   group_by(`Coral full name`, Type) %>% 
   summarize(mean = round(mean(value),2), sd = round(sd(value),2), 
             n = length(value), 
             .groups = "drop") %>% 
   ggplot(data=., aes(x=`Coral full name`, fill =Type)) +
   geom_bar(stat = "identity", position = "stack", 
            aes(y = mean)) +
   #geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, fig.cap="Figure 7_23. Extent of old and new morality by diver in 2023. Check for possible over- or under-estimating."}
chs_corals_23 %>%  
   pivot_longer(cols = c(`Old mortality`, `Recent mortality`), 
                names_to = "Type", values_to = "value") %>% 
   group_by(Name, Type) %>% 
   summarize(mean = round(mean(value),2), sd = round(sd(value),2), 
             n = length(value), 
             .groups = "drop") %>% 
   add_row(Name = "Overall", Type="Old mortality", 
           mean = round(mean(chs_corals_23$`Old mortality`),2), 
           sd = round(sd(chs_corals_23$`Old mortality`),2),
           n = length(chs_corals_23$`Old mortality`)) %>% 
   add_row(Name = "Overall", Type="Recent mortality", 
           mean = round(mean(chs_corals_23$`Recent mortality`),2), 
           sd = round(sd(chs_corals_23$`Recent mortality`),2),
           n = length(chs_corals_23$`Recent mortality`)) %>% 
   mutate(Name=factor(Name,levels=c("Overall",coraldiverlist_23))) %>% 
   ggplot(data=., aes(x=Name, fill =Type)) +
   geom_bar(stat = "identity", position = "stack", 
            aes(y = mean)) +
   #geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, fig.cap="Figure 7_24. Extent of old and new morality by diver in 2024. Check for possible over- or under-estimating."}
chs_corals_24 %>%  
   pivot_longer(cols = c(`Old mortality`, `Recent mortality`), 
                names_to = "Type", values_to = "value") %>% 
   group_by(Name, Type) %>% 
   summarize(mean = round(mean(value),2), sd = round(sd(value),2), 
             n = length(value), 
             .groups = "drop") %>% 
   add_row(Name = "Overall", Type="Old mortality", 
           mean = round(mean(chs_corals_24$`Old mortality`),2), 
           sd = round(sd(chs_corals_24$`Old mortality`),2),
           n = length(chs_corals_24$`Old mortality`)) %>% 
   add_row(Name = "Overall", Type="Recent mortality", 
           mean = round(mean(chs_corals_24$`Recent mortality`),2), 
           sd = round(sd(chs_corals_24$`Recent mortality`),2),
           n = length(chs_corals_24$`Recent mortality`)) %>% 
   mutate(Name=factor(Name,levels=c("Overall",coraldiverlist_24))) %>% 
   ggplot(data=., aes(x=Name, fill =Type)) +
   geom_bar(stat = "identity", position = "stack", 
            aes(y = mean)) +
   #geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

## Bleaching

```{r, fig.cap="Figure 8_23. Prevalence of bleaching types by coral species in 2023."}
bl_cols <- c("BL"="gray100","VP"="gray75","P"="gray50","SP"="gray25")
chs_corals_23 %>%  
   mutate(`Bl sp`= ifelse(`Bl sp`>0,1,0),
          `Bl p`= ifelse(`Bl p`>0,1,0),
          `Bl vp`= ifelse(`Bl vp`>0,1,0),
          `Bl bl`= ifelse(`Bl bl`>0,1,0)) %>% 
   group_by(`Coral full name`) %>% 
   summarize(`Bl sp`=sum(`Bl sp`)/length(`Bl sp`),
             `Bl p`=sum(`Bl p`)/length(`Bl p`),
             `Bl vp`=sum(`Bl vp`)/length(`Bl vp`),
             `Bl bl`=sum(`Bl bl`)/length(`Bl bl`),
             .groups = "drop") %>% 
   pivot_longer(!`Coral full name`, 
                names_to = "Type", values_to = "value") %>% 
   # Reformat bleaching labels
   mutate(Type=str_to_upper(gsub("Bl ","", Type))) %>% 
   mutate(Type=factor(Type, levels = c("BL","VP","P","SP"))) %>% 
   # Plot
   ggplot(data=., aes(x=`Coral full name`, fill =Type)) +
   geom_bar(stat = "identity", position = "dodge", 
            aes(y = value), color="black") +
   scale_fill_manual(values=bl_cols) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, fig.cap="Figure 8_24. Prevalence of bleaching types by coral species in 2024PBL."}
chs_corals_24 %>%  
   mutate(`Bl sp`= ifelse(`Bl sp`>0,1,0),
          `Bl p`= ifelse(`Bl p`>0,1,0),
          `Bl vp`= ifelse(`Bl vp`>0,1,0),
          `Bl bl`= ifelse(`Bl bl`>0,1,0)) %>% 
   group_by(`Coral full name`) %>% 
   summarize(`Bl sp`=sum(`Bl sp`)/length(`Bl sp`),
             `Bl p`=sum(`Bl p`)/length(`Bl p`),
             `Bl vp`=sum(`Bl vp`)/length(`Bl vp`),
             `Bl bl`=sum(`Bl bl`)/length(`Bl bl`),
             .groups = "drop") %>% 
   pivot_longer(!`Coral full name`, 
                names_to = "Type", values_to = "value") %>% 
   # Reformat bleaching labels
   mutate(Type=str_to_upper(gsub("Bl ","", Type))) %>% 
   mutate(Type=factor(Type, levels = c("BL","VP","P","SP"))) %>% 
   # Plot
   ggplot(data=., aes(x=`Coral full name`, fill =Type)) +
   geom_bar(stat = "identity", position = "dodge", 
            aes(y = value), color="black") +
   scale_fill_manual(values=bl_cols) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, fig.cap="Figure 9_23. Prevalence of bleaching types by diver in 2023. Check for possible over- or under-estimating."}
chs_corals_23 %>%  
   mutate(`Bl sp`= ifelse(`Bl sp`>0,1,0),
          `Bl p`= ifelse(`Bl p`>0,1,0),
          `Bl vp`= ifelse(`Bl vp`>0,1,0),
          `Bl bl`= ifelse(`Bl bl`>0,1,0)) %>% 
   group_by(Name) %>% 
   summarize(`Bl sp`=sum(`Bl sp`)/length(`Bl sp`),
             `Bl p`=sum(`Bl p`)/length(`Bl p`),
             `Bl vp`=sum(`Bl vp`)/length(`Bl vp`),
             `Bl bl`=sum(`Bl bl`)/length(`Bl bl`),
             .groups = "drop") %>% 
   pivot_longer(!Name, 
                names_to = "Type", values_to = "value") %>% 
   add_row(Name = "Overall", Type="Bl sp", 
           value = nrow(filter(chs_corals_23,`Bl sp`>0))/nrow(chs_corals_23)) %>% 
   add_row(Name = "Overall", Type="Bl p", 
           value = nrow(filter(chs_corals_23,`Bl p`>0))/nrow(chs_corals_23)) %>% 
   add_row(Name = "Overall", Type="Bl vp", 
           value = nrow(filter(chs_corals_23,`Bl vp`>0))/nrow(chs_corals_23)) %>% 
   add_row(Name = "Overall", Type="Bl bl", 
           value = nrow(filter(chs_corals_23,`Bl bl`>0))/nrow(chs_corals_23)) %>% 
   # Reformat bleaching and diver labels
   mutate(Type=str_to_upper(gsub("Bl ","", Type))) %>% 
   mutate(Type=factor(Type, levels = c("BL","VP","P","SP"))) %>% 
   mutate(Name=factor(Name,levels=c("Overall",coraldiverlist_23))) %>% 
   # Plot
   ggplot(data=., aes(x=Name, fill =Type)) +
   geom_bar(stat = "identity", position = "dodge", 
            aes(y = value), color="black") +
   scale_fill_manual(values=bl_cols) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, fig.cap="Figure 9_24. Prevalence of bleaching types by diver in 2024PBL. Check for possible over- or under-estimating."}
chs_corals_24 %>%  
   mutate(`Bl sp`= ifelse(`Bl sp`>0,1,0),
          `Bl p`= ifelse(`Bl p`>0,1,0),
          `Bl vp`= ifelse(`Bl vp`>0,1,0),
          `Bl bl`= ifelse(`Bl bl`>0,1,0)) %>% 
   group_by(Name) %>% 
   summarize(`Bl sp`=sum(`Bl sp`)/length(`Bl sp`),
             `Bl p`=sum(`Bl p`)/length(`Bl p`),
             `Bl vp`=sum(`Bl vp`)/length(`Bl vp`),
             `Bl bl`=sum(`Bl bl`)/length(`Bl bl`),
             .groups = "drop") %>% 
   pivot_longer(!Name, 
                names_to = "Type", values_to = "value") %>% 
   add_row(Name = "Overall", Type="Bl sp", 
           value = nrow(filter(chs_corals_24,`Bl sp`>0))/nrow(chs_corals_23)) %>% 
   add_row(Name = "Overall", Type="Bl p", 
           value = nrow(filter(chs_corals_24,`Bl p`>0))/nrow(chs_corals_23)) %>% 
   add_row(Name = "Overall", Type="Bl vp", 
           value = nrow(filter(chs_corals_24,`Bl vp`>0))/nrow(chs_corals_23)) %>% 
   add_row(Name = "Overall", Type="Bl bl", 
           value = nrow(filter(chs_corals_24,`Bl bl`>0))/nrow(chs_corals_23)) %>% 
   # Reformat bleaching and diver labels
   mutate(Type=str_to_upper(gsub("Bl ","", Type))) %>% 
   mutate(Type=factor(Type, levels = c("BL","VP","P","SP"))) %>% 
   mutate(Name=factor(Name,levels=c("Overall",coraldiverlist_24))) %>% 
   # Plot
   ggplot(data=., aes(x=Name, fill =Type)) +
   geom_bar(stat = "identity", position = "dodge", 
            aes(y = value), color="black") +
   scale_fill_manual(values=bl_cols) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, warning=FALSE, fig.cap="Figure 10_23. Extent of bleaching types by coral species in 2023."}
chs_corals_23 %>%  
   pivot_longer(cols = starts_with("Bl"), 
                names_to = "Type", values_to = "value") %>% 
   group_by(`Coral full name`, Type) %>% 
   summarize(mean = round(mean(value),2), sd = round(sd(value),2), 
             n = length(value), 
             .groups = "drop") %>% 
   # Reformat bleaching labels
   mutate(Type=str_to_upper(gsub("Bl ","", Type))) %>% 
   mutate(Type=factor(Type, levels = c("BL","VP","P","SP"))) %>% 
   # Plot
   ggplot(data=., aes(x=`Coral full name`, fill =Type)) +
   geom_bar(stat = "identity", position = "stack", 
            aes(y = mean), color="black") +
   scale_fill_manual(values=bl_cols) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, warning=FALSE, fig.cap="Figure 10_24. Extent of bleaching types by coral species in 2024PBL."}
chs_corals_24 %>%  
   pivot_longer(cols = starts_with("Bl"),
                names_to = "Type", values_to = "value") %>% 
   group_by(`Coral full name`, Type) %>% 
   summarize(mean = round(mean(value),2), sd = round(sd(value),2), 
             n = length(value), 
             .groups = "drop") %>% 
   # Reformat bleaching labels
   mutate(Type=str_to_upper(gsub("Bl ","", Type))) %>% 
   mutate(Type=factor(Type, levels = c("BL","VP","P","SP"))) %>% 
   # Plot
   ggplot(data=., aes(x=`Coral full name`, fill =Type)) +
   geom_bar(stat = "identity", position = "stack", 
            aes(y = mean), color="black") +
   scale_fill_manual(values=bl_cols) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, fig.cap="Figure 11_23. Extent of bleaching types by diver in 2023. Check for possible over- or under-estimating."}
chs_corals_23 %>%  
   pivot_longer(cols = starts_with("Bl"), 
                names_to = "Type", values_to = "value") %>% 
   group_by(Name, Type) %>% 
   summarize(mean = round(mean(value),2), sd = round(sd(value),2), 
             n = length(value), 
             .groups = "drop") %>% 
   add_row(Name = "Overall", Type="Bl sp", 
           mean = round(mean(chs_corals_23$`Bl sp`),2)) %>% 
   add_row(Name = "Overall", Type="Bl p", 
           mean = round(mean(chs_corals_23$`Bl p`),2)) %>% 
   add_row(Name = "Overall", Type="Bl vp", 
           mean = round(mean(chs_corals_23$`Bl vp`),2)) %>% 
   add_row(Name = "Overall", Type="Bl bl", 
           mean = round(mean(chs_corals_23$`Bl bl`),2)) %>% 
   # Reformat bleaching and diver labels
   mutate(Type=str_to_upper(gsub("Bl ","", Type))) %>% 
   mutate(Type=factor(Type, levels = c("BL","VP","P","SP"))) %>% 
   mutate(Name=factor(Name,levels=c("Overall",coraldiverlist_23))) %>% 
   # Plot
   ggplot(data=., aes(x=Name, fill =Type)) +
   geom_bar(stat = "identity", position = "stack", 
            aes(y = mean), color="black") +
   scale_fill_manual(values=bl_cols) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r, fig.cap="Figure 11_24. Extent of bleaching types by diver in 2024PBL. Check for possible over- or under-estimating."}
chs_corals_24 %>%  
   pivot_longer(cols = starts_with("Bl"), 
                names_to = "Type", values_to = "value") %>% 
   group_by(Name, Type) %>% 
   summarize(mean = round(mean(value),2), sd = round(sd(value),2), 
             n = length(value), 
             .groups = "drop") %>% 
   add_row(Name = "Overall", Type="Bl sp", 
           mean = round(mean(chs_corals_24$`Bl sp`),2)) %>% 
   add_row(Name = "Overall", Type="Bl p", 
           mean = round(mean(chs_corals_24$`Bl p`),2)) %>% 
   add_row(Name = "Overall", Type="Bl vp", 
           mean = round(mean(chs_corals_24$`Bl vp`),2)) %>% 
   add_row(Name = "Overall", Type="Bl bl", 
           mean = round(mean(chs_corals_24$`Bl bl`),2)) %>% 
   # Reformat bleaching and diver labels
   mutate(Type=str_to_upper(gsub("Bl ","", Type))) %>% 
   mutate(Type=factor(Type, levels = c("BL","VP","P","SP"))) %>% 
   mutate(Name=factor(Name,levels=c("Overall",coraldiverlist_24))) %>% 
   # Plot
   ggplot(data=., aes(x=Name, fill =Type)) +
   geom_bar(stat = "identity", position = "stack", 
            aes(y = mean), color="black") +
   scale_fill_manual(values=bl_cols) +
   theme(axis.text.x = element_text(angle = 45, hjust=1))
```

## Interactions

What were the most common interactions and their average values?

```{r, tab.cap="Table 11_23. Most common interactions and their average values in 2023."}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
chs_raw_23 %>% 
   filter(!is.na(`Interaction name`)) %>% 
   group_by(`Interaction name`) %>% 
   summarize(n = length(`Interaction value`),
             mean = round(mean(`Interaction value`),2),
             sd = round(sd(`Interaction value`),2),
             max = max(`Interaction value`),
             min = min(`Interaction value`)) %>% 
   arrange(desc(n)) %>% datatable()
```

```{r, tab.cap="Table 11_24. Most common interactions and their average values in 2024PBL."}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
chs_raw_24 %>% 
   filter(!is.na(`Interaction name`)) %>% 
   group_by(`Interaction name`) %>% 
   summarize(n = length(`Interaction value`),
             mean = round(mean(`Interaction value`),2),
             sd = round(sd(`Interaction value`),2),
             max = max(`Interaction value`),
             min = min(`Interaction value`)) %>% 
   arrange(desc(n)) %>% datatable()

```

```{r, tab.cap="Table 12_23. Summary of number of interactions recorded by each diver in 2023, and summary of corals with and without interactions. Interaction summary numbers only include corals with at least 1 interaction."}
propInts_23 <- chs_raw_23 %>% 
   filter(is.na(`Interaction name`)) %>% 
   group_by(Name) %>% 
   summarize(CoralsNoInts = length(`Transect coral`))
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
chs_raw_23 %>% 
   filter(!is.na(`Interaction name`)) %>% 
   group_by(Name,`Transect coral`) %>% 
   summarize(Interactions = length(`Interaction name`), 
             .groups="drop_last") %>% 
   summarize(CoralsWInts = length(Interactions),
             MeanInts = round(mean(Interactions),2),
             sd = round(sd(Interactions),2),
             max = max(Interactions),
             min = min(Interactions), .groups="drop") %>% 
   left_join(propInts_23, by="Name") %>% 
   mutate(TotCorals = CoralsWInts + CoralsNoInts) %>% 
   mutate(PropWInts = round(CoralsWInts / TotCorals*100)) %>% 
   select(-CoralsNoInts) %>% 
   arrange(desc(MeanInts)) %>% datatable()
```

```{r, tab.cap="Table 12_24. Summary of number of interactions recorded by each diver in 2024, and summary of corals with and without interactions. Interaction summary numbers only include corals with at least 1 interaction."}
propInts_24 <- chs_raw_24 %>% 
   filter(is.na(`Interaction name`)) %>% 
   group_by(Name) %>% 
   summarize(CoralsNoInts = length(`Transect coral`))
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
chs_raw_24 %>% 
   filter(!is.na(`Interaction name`)) %>% 
   group_by(Name,`Transect coral`) %>% 
   summarize(Interactions = length(`Interaction name`), 
             .groups="drop_last") %>% 
   summarize(CoralsWInts = length(Interactions),
             MeanInts = round(mean(Interactions),2),
             sd = round(sd(Interactions),2),
             max = max(Interactions),
             min = min(Interactions), .groups="drop") %>% 
   left_join(propInts_24, by="Name") %>% 
   mutate(TotCorals = CoralsWInts + CoralsNoInts) %>% 
   mutate(PropWInts = round(CoralsWInts / TotCorals*100)) %>% 
   select(-CoralsNoInts) %>% 
   arrange(desc(MeanInts)) %>% datatable()

```

```{r}
# More ideas
# 
# focus on diver trends to generate info for feedback on training.
# 
# coral size flags table. what is our 99% vs ncrmp? how many are flagged?
```

# Algae Heights

## Abundance

```{r, tab.cap="Table 13. Number of algal points per transect on average across sites in 2023."}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
ahs_raw %>% 
   group_by(`Site name`, Rep) %>% 
   summarize(Algaes = length(`Code name`), .groups = "drop_last") %>% 
   summarize(n=length(Algaes), mean = round(mean(Algaes),1), 
             sd = round(sd(Algaes),1), 
             min = min(Algaes), max = max(Algaes), .groups="drop") %>% 
   arrange(desc(mean)) %>% datatable()
```

Buck STX was 90% CYAN, which was not recorded. We may want to delete this data altogether.

## Sizing

```{r, tab.cap="Table 14. Height (cm) of each species of algae in 2023. You can use this table to look at rare species as well."}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
ahs_raw %>% 
   group_by(`Code name`) %>% 
   summarize(n=length(`Height cm`), mean = round(mean(`Height cm`),1), 
             sd = round(sd(`Height cm`),1), 
             min = min(`Height cm`), max = max(`Height cm`), .groups="drop") %>% 
   arrange(desc(mean)) %>% datatable()
```

FILSED should not be 7.5 cm. What happened there? Let's look at the FILSED \> 2 cm.

```{r, tab.cap="Table 15. A closer look at FILSED points > 2cm in 2023."}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
ahs_raw %>% 
   filter(`Code name`=="FILSED") %>% 
   filter(`Height cm`>2) %>% 
   arrange(desc(`Height cm`)) %>% 
   select(-Notes,-`Algae height`,-`Full name`,-Proofed) %>% datatable()
```

Also 9.6 cm LOBO? They can be quite fleshy at deep sites but that's a lot. Let's look at LOBO \> 3 cm.

```{r, tab.cap="Table 16. A closer look at LOBO points > 3cm in 2023."}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
ahs_raw %>% 
   filter(`Code name`=="LOBO") %>% 
   filter(`Height cm`>3) %>% 
   arrange(desc(`Height cm`)) %>% 
   select(-Notes,-`Algae height`,-`Full name`,-Proofed) %>% datatable()
```

Could these transects be in mm instead of cm? Look at Erin's Magens data and Shaun's BIT data.

```{r, tab.cap="Table 17. A closer look at Erin's algae height transects at Magens to determine if they might be in the wrong units."}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
ahs_raw %>% 
   filter(`Site name`=="Magens Bay", Name == "HOLLANDER_ERIN") %>% 
   select(-Notes,-`Algae height`,-`Full name`,-Proofed) %>% datatable()
```

Erin's look like they might be mm.

```{r, tab.cap="Table 18. A closer look at Shaun's algae height transects at Buck STT to determine if they might be in the wrong units."}
kable(x=tibble(" "=" ")) # hacky way to put the caption above the datatable
ahs_raw %>% 
   filter(`Site name`=="Buck Island STT", Name == "KADISON_SHAUN") %>% 
   select(-Notes,-`Algae height`,-`Full name`,-Proofed) %>% datatable()
```

Shaun has enough decimals that I think they are cm.
